# IntegraÃ§Ã£o com Chat do FoundryVTT - Cyberpunk Agent

## VisÃ£o Geral

O Cyberpunk Agent agora integra completamente com o sistema de chat nativo do FoundryVTT, oferecendo:

- **Mensagens reais no chat** do FoundryVTT
- **SincronizaÃ§Ã£o bidirecional** entre Chat7 e chat nativo
- **EstilizaÃ§Ã£o cyberpunk** para mensagens no chat
- **Controle de visibilidade** baseado em permissÃµes
- **PersistÃªncia automÃ¡tica** no histÃ³rico do FoundryVTT

## Como Funciona

### 1. Sistema de Chat do FoundryVTT

O FoundryVTT usa um sistema robusto baseado em `ChatMessage`:

```javascript
// Tipos de mensagem disponÃ­veis
CONST.CHAT_MESSAGE_TYPES = {
    OTHER: 0,      // Mensagem do sistema
    OOC: 1,        // Out of Character
    IC: 2,         // In Character (padrÃ£o para agent)
    EMOTE: 3,      // Emote
    WHISPER: 4,    // Sussurro
    ROLL: 5        // Rolagem
}
```

### 2. Fluxo de IntegraÃ§Ã£o

```
Chat7 (Envia) â†’ Sistema Interno â†’ ChatMessage.create() â†’ Chat do FoundryVTT
     â†“
  SocketLib â†’ Outros Clientes â†’ ChatMessage.create() â†’ Chat do FoundryVTT
     â†“
  SincronizaÃ§Ã£o â†’ Ambos os sistemas atualizados
```

### 3. Estrutura de Mensagem

Cada mensagem do Agent no chat do FoundryVTT contÃ©m:

```javascript
{
    user: game.user.id,
    speaker: {
        Actor: senderId,
        alias: senderName
    },
    content: `<div class="cyberpunk-agent-chat-message">
        <div class="cyberpunk-agent-chat-header">
            <img src="${sender.img}" />
            <span>${sender.name} â†’ ${receiver.name}</span>
        </div>
        <div class="cyberpunk-agent-chat-content">
            ${messageText}
        </div>
        <div class="cyberpunk-agent-chat-time">
            ${timestamp}
        </div>
    </div>`,
    type: CONST.CHAT_MESSAGE_TYPES.IC,
    whisper: [userIds], // Controle de visibilidade
    blind: false,
    flags: {
        'cyberpunk-agent': {
            isAgentMessage: true,
            messageId: uniqueId,
            senderId: senderId,
            receiverId: receiverId,
            timestamp: Date.now()
        }
    }
}
```

## ImplementaÃ§Ã£o TÃ©cnica

### 1. CriaÃ§Ã£o de Mensagens

```javascript
// MÃ©todo principal
_createFoundryChatMessage(senderId, receiverId, text, messageId) {
    // Determina visibilidade baseada em permissÃµes
    const senderUser = this._getUserForActor(senderId);
    const receiverUser = this._getUserForActor(receiverId);
    
    let whisper = [];
    let blind = false;
    
    // Adiciona usuÃ¡rios que devem ver a mensagem
    if (senderUser && !senderUser.isGM) whisper.push(senderUser.id);
    if (receiverUser && !receiverUser.isGM) whisper.push(receiverUser.id);
    
    // Se hÃ¡ whispers, torna blind para outros
    if (whisper.length > 0) blind = true;
    
    // Cria a mensagem
    ChatMessage.create(messageData);
}
```

### 2. Leitura de Mensagens

```javascript
// ObtÃ©m mensagens do chat do FoundryVTT
getMessagesFromFoundryChat(actorId1, actorId2) {
    const messages = [];
    const chatMessages = game.messages.contents;
    
    for (const chatMessage of chatMessages) {
        if (chatMessage.flags?.['cyberpunk-agent']?.isAgentMessage) {
            const agentFlags = chatMessage.flags['cyberpunk-agent'];
            
            // Verifica se pertence Ã  conversa
            if ((agentFlags.senderId === actorId1 && agentFlags.receiverId === actorId2) ||
                (agentFlags.senderId === actorId2 && agentFlags.receiverId === actorId1)) {
                
                // Extrai conteÃºdo da mensagem
                const content = this._parseChatMessageContent(chatMessage.content);
                messages.push({
                    id: agentFlags.messageId,
                    senderId: agentFlags.senderId,
                    receiverId: agentFlags.receiverId,
                    text: content.text,
                    timestamp: agentFlags.timestamp,
                    time: content.time,
                    isOwn: agentFlags.senderId === actorId1,
                    chatMessageId: chatMessage.id
                });
            }
        }
    }
    
    return messages.sort((a, b) => a.timestamp - b.timestamp);
}
```

### 3. SincronizaÃ§Ã£o

```javascript
// Sincroniza mensagens entre sistemas
syncMessagesWithFoundryChat() {
    this.messages.forEach((conversation, conversationKey) => {
        const [actorId1, actorId2] = conversationKey.split('-');
        const foundryMessages = this.getMessagesFromFoundryChat(actorId1, actorId2);
        const mergedMessages = this._mergeMessages(conversation, foundryMessages);
        this.messages.set(conversationKey, mergedMessages);
    });
    
    this.saveMessages();
}
```

## Controle de Visibilidade

### 1. Regras de Visibilidade

- **GM**: VÃª todas as mensagens
- **Jogador (Sender)**: VÃª mensagens que enviou
- **Jogador (Receiver)**: VÃª mensagens que recebeu
- **Outros Jogadores**: NÃ£o veem mensagens privadas

### 2. ImplementaÃ§Ã£o

```javascript
// Determina quem deve ver a mensagem
let whisper = [];
let blind = false;

// Sender vÃª se for jogador
if (senderUser && !senderUser.isGM) {
    whisper.push(senderUser.id);
}

// Receiver vÃª se for jogador
if (receiverUser && !receiverUser.isGM) {
    whisper.push(receiverUser.id);
}

// Se hÃ¡ whispers, torna blind para outros
if (whisper.length > 0) {
    blind = true;
}
```

## EstilizaÃ§Ã£o

### 1. CSS para Mensagens no Chat

```css
.cyberpunk-agent-chat-message {
    background: linear-gradient(135deg, rgba(0, 255, 0, 0.1) 0%, rgba(0, 0, 0, 0.2) 100%);
    border: 1px solid rgba(0, 255, 0, 0.3);
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    font-family: 'Courier New', monospace;
    position: relative;
}

.cyberpunk-agent-chat-message::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #00ff00, #00cc00, #00ff00);
    border-radius: 8px 8px 0 0;
}
```

### 2. Elementos Visuais

- **Header**: Avatar, nome do sender, seta, nome do receiver
- **Content**: Texto da mensagem
- **Time**: Timestamp da mensagem
- **Borda superior**: Gradiente verde cyberpunk

## Funcionalidades

### âœ… Implementadas

- [x] CriaÃ§Ã£o de mensagens no chat do FoundryVTT
- [x] Leitura de mensagens do chat
- [x] SincronizaÃ§Ã£o bidirecional
- [x] Controle de visibilidade
- [x] EstilizaÃ§Ã£o cyberpunk
- [x] PersistÃªncia automÃ¡tica
- [x] Hooks para atualizaÃ§Ã£o em tempo real
- [x] Merge inteligente de mensagens

### ğŸ”„ Em Desenvolvimento

- [ ] Filtros de mensagem no chat
- [ ] Busca de mensagens
- [ ] ExportaÃ§Ã£o de conversas
- [ ] NotificaÃ§Ãµes sonoras
- [ ] Indicadores de status

## Testes

### FunÃ§Ãµes de Teste DisponÃ­veis

Execute no console do navegador:

```javascript
// Teste de integraÃ§Ã£o com chat
testFoundryChatIntegration()

// Sincronizar mensagens
syncFoundryChat()

// Obter mensagens do chat
getFoundryChatMessages(actorId1, actorId2)
```

### Exemplo de Teste

```javascript
// Teste completo
testFoundryChatIntegration();

// Verificar mensagens apÃ³s envio
setTimeout(() => {
    const characterActors = game.actors.filter(actor => actor.type === 'character');
    if (characterActors.length >= 2) {
        const messages = getFoundryChatMessages(characterActors[0].id, characterActors[1].id);
        console.log("Mensagens encontradas:", messages.length);
    }
}, 2000);
```

## Vantagens da IntegraÃ§Ã£o

### 1. **PersistÃªncia Nativa**
- Mensagens ficam no histÃ³rico do FoundryVTT
- Sobrevivem a recarregamentos
- Backup automÃ¡tico com o mundo

### 2. **Compatibilidade**
- Funciona com todos os mÃ³dulos de chat
- Integra com sistema de permissÃµes
- Suporte a hooks nativos

### 3. **Visibilidade**
- Controle granular de quem vÃª o quÃª
- Whisper automÃ¡tico para privacidade
- Blind para mensagens sensÃ­veis

### 4. **Performance**
- Usa sistema otimizado do FoundryVTT
- Cache automÃ¡tico de mensagens
- Lazy loading de histÃ³rico

## Troubleshooting

### Problemas Comuns

#### 1. Mensagens nÃ£o aparecem no chat

**Sintomas:**
- Mensagem enviada mas nÃ£o visÃ­vel no chat
- Erro ao criar ChatMessage

**SoluÃ§Ãµes:**
1. Verifique permissÃµes de GM
2. Use `testFoundryChatIntegration()` para testar
3. Verifique logs do console
4. Reinicie o mÃ³dulo

#### 2. SincronizaÃ§Ã£o nÃ£o funciona

**Sintomas:**
- Mensagens duplicadas
- Mensagens faltando

**SoluÃ§Ãµes:**
1. Use `syncFoundryChat()` para forÃ§ar sincronizaÃ§Ã£o
2. Verifique se hÃ¡ conflitos de ID
3. Limpe cache do navegador

#### 3. EstilizaÃ§Ã£o nÃ£o aplicada

**Sintomas:**
- Mensagens sem estilo cyberpunk
- CSS nÃ£o carregado

**SoluÃ§Ãµes:**
1. Verifique se o CSS foi carregado
2. Recarregue a pÃ¡gina
3. Verifique conflitos com outros mÃ³dulos

### Logs de Debug

```javascript
// Verificar integraÃ§Ã£o
console.log("Chat messages:", game.messages.contents.length);
console.log("Agent messages:", game.messages.contents.filter(m => m.flags?.['cyberpunk-agent']).length);

// Verificar permissÃµes
const actor = game.actors.get(actorId);
console.log("Actor ownership:", actor.ownership);
```

## ConfiguraÃ§Ã£o

### 1. ConfiguraÃ§Ãµes do MÃ³dulo

No mÃ³dulo Cyberpunk Agent:

- **IntegraÃ§Ã£o com Chat**: Ativada por padrÃ£o
- **Tipo de Mensagem**: IC (In Character)
- **Visibilidade**: AutomÃ¡tica baseada em permissÃµes

### 2. ConfiguraÃ§Ãµes do FoundryVTT

- **Chat Log**: Deve estar ativo
- **PermissÃµes**: Configuradas corretamente
- **MÃ³dulos de Chat**: CompatÃ­veis

## Compatibilidade

### Sistemas Suportados

- âœ… FoundryVTT v11+
- âœ… Cyberpunk RED Core
- âœ… Todos os mÃ³dulos de chat
- âœ… Sistema de permissÃµes nativo

### MÃ³dulos Testados

- âœ… Chat Portrait
- âœ… Chat Enhancements
- âœ… Better Chat
- âœ… Chat Commands

## Desenvolvimento

### Estrutura de Arquivos

```
scripts/
â”œâ”€â”€ module.js                   # LÃ³gica principal + integraÃ§Ã£o chat
â”œâ”€â”€ socketlib-integration.js    # ComunicaÃ§Ã£o em tempo real
â””â”€â”€ agent-home.js              # Interfaces de chat

styles/
â””â”€â”€ module.css                 # Estilos para chat do FoundryVTT
```

### Hooks Utilizados

```javascript
// CriaÃ§Ã£o de mensagens
Hooks.on('createChatMessage', (message) => {
    this._handleNewChatMessage(message);
});

// RenderizaÃ§Ã£o de mensagens
Hooks.on('renderChatMessage', (message, html, data) => {
    // PersonalizaÃ§Ã£o adicional se necessÃ¡rio
});
```

### Extensibilidade

Para adicionar novas funcionalidades:

1. **Novos tipos de mensagem**: Adicione ao `CONST.CHAT_MESSAGE_TYPES`
2. **Novos estilos**: Adicione CSS para `.cyberpunk-agent-chat-message`
3. **Novos hooks**: Registre handlers para eventos de chat
4. **Novos flags**: Adicione metadados Ã s mensagens

## Suporte

Para problemas ou dÃºvidas:

1. Verifique esta documentaÃ§Ã£o
2. Execute testes de diagnÃ³stico
3. Verifique logs do console
4. Teste com mÃ³dulos desabilitados
5. Abra uma issue no GitHub 